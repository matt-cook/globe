<!-- source: https://github.com/zebradog/globe -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Globe</title>
    <script type="text/javascript">
    if(!window.chrome) {
      alert("This application requires Google Chrome");
      window.location = "http://www.google.com/chrome";
    }
    </script>
    <script src="js/lib/jquery.min.js"></script>
    <script src="js/lib/jquery.transit.min.js"></script>
    <script src="js/lib/stretch-video.js"></script>
    <script src="js/lib/d3.min.js"></script>
    <script src="js/lib/Cesium/Cesium.js"></script>
    <script src="js/lib/dat.gui.min.js"></script>
    <style>
      @import url(js/lib/Cesium/Widgets/widgets.css);
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
        background-image:url(img/bg.jpg);
        background-size:cover;
        font-family: sans-serif;
      }
      #map{
        -webkit-filter: contrast(80%) saturate(100%) brightness(100%) sepia(25%) drop-shadow(0px 0px 40px rgb(245,245,210));
      }
      #content{
        background-image:url(img/content.jpg);
        background-size:cover;
        opacity:0;
      }
      #clouds, .cloud, #overlay, #content, video, svg{
        pointer-events:none;
      }
      .container,#cesiumContainer{
        position:absolute;
        top:0;
        left:0;
        bottom:0;
        right:0;
        height:100%;
        width:100%;
        margin:0;
        padding:0;
        overflow:hidden;
      }
      video{
        position:absolute;
        z-index:2;
      }
      .dg.ac{
        z-index:3;
      }
      video.StretchtoFit{ width: 100%; /* Important: No Height attribute is being specified */ }
      #overlay{
        z-index:1;
      }
      .point{
        height:10px;
        width:10px;
        position:absolute;
        display:block;
        background:#000;
        border:4px solid white;
        border-radius:20px;
      }
      .point:before{
        content:'';
        display:block;
        height:18px;
        width:18px;
        top:-7px;
        left:-7px;
        position:absolute;
        border:3px solid #000;
        border-radius:18px;
      }
      .point .label{
        white-space: nowrap;
        background: #f2eede;
        text-align: center;
        position: absolute;
        top:-34px;
        right:-30px;
        color: #573e3a;
        text-transform: uppercase;
        font-weight: bold;
        padding: 3px 20px 1px 20px;
        box-shadow: 2px 2px 8px 0px rgba(0,0,0,0.5);
        display:inline;
        visibility:hidden;
      }
      .point.highlighted{
        border-color:yellow;
      }
      .highlighted.point .label{
        visibility:visible;
      }
    </style>
  </head>
<body>
  <div id="map" class="container"></div>
  <div id="overlay" class="container">
    <div class="point city trondheim" data-latitude="63.4187362" data-longitude="10.4387621">
      <div class="label">Trondheim</div>
    </div>
    <div class="point city bergen" data-latitude="60.3894" data-longitude="5.3300">
      <div class="label">Bergen</div>
    </div>
    <div class="point city liverpool" data-latitude="53.4200911" data-longitude="-2.9108429">
      <div class="label">Liverpool, UK</div>
    </div>
    <div class="point city new-york highlighted" data-latitude="40.7056308" data-longitude="-73.9780035">
      <div class="label">New York, New York</div>
    </div>
    <div class="point city stoughton highlighted" data-latitude="42.9230266" data-longitude="-89.2180235">
      <div class="label">Stoughton, Wisconsin</div>
    </div>
    <div class="point city christiana highlighted" data-latitude="59.8938549" data-longitude="10.7851166">
      <div class="label">Christiania</div>
    </div>
    <div class="point city arendal highlighted" data-latitude="58.4687227" data-longitude="8.7618567">
      <div class="label">Arendal</div>
    </div>
    <div class="point city kristiansand highlighted" data-latitude="58.1529776" data-longitude="8.0092118">
      <div class="label">Kristiansand</div>
    </div>
    <div class="point city hamburg highlighted" data-latitude="53.558572" data-longitude="9.9278215">
      <div class="label">Hamburg, Germany</div>
    </div>
  </div>
  <div id="content" class="container"></div>
  <div class="cloud container">
    <video id="zoom" class="StretchtoFit" src="video/zoom.webm"></video>
    <video id="clouds" class="StretchtoFit" autoplay src="video/clouds.webm" loop></video>
  </div>
  <script>
  
  var route = [
    "christiana",
    "arendal",
    "kristiansand",
    "hamburg",
    "new-york",
    "stoughton"
  ];
  
  var lines = {};
  
  var SETTINGS = {};
  SETTINGS["Outline Norway"] = false;
  SETTINGS["Zoom Duration"] = 10.0;
  SETTINGS["Video Transition"] = 30; //point at which video is solid white, in seconds
  var isZoomed = false;
  SETTINGS["Zoom"] = function(){
    if(isZoomed){
      $("#content").transition({opacity:0});
      viewer.scene.animations.add(Cesium.CameraFlightPath.createAnimation(viewer.scene, {
        destination : start.position,
        direction: start.direction,
        up: start.up,
        duration: SETTINGS["Zoom Duration"]*1000
      }));
    }else{
      var v = document.getElementById('zoom');
      v.playbackRate = v.duration/SETTINGS["Zoom Duration"];
      v.currentTime = 0;
      v.onended = function(){
        document.getElementById('zoom').pause();
      }
      v.addEventListener('timeupdate',function(){
        var v = document.getElementById('zoom');
        if(v.currentTime >= SETTINGS["Video Transition"]){
          v.pause();
          $("#content").css({opacity:1});
          v.play();
        }
      });
      v.play();
      viewer.scene.animations.add(Cesium.CameraFlightPath.createAnimation(viewer.scene, {
        destination : new Cesium.Cartesian3(3171739,362164.0727772717,5505013.132590841),
        duration: SETTINGS["Zoom Duration"]*1000
      }));
    }
    isZoomed = !isZoomed;
  };
  
  
    var viewer = new Cesium.Viewer('map', {
      animation:false,
      baseLayerPicker:false,
      fullscreenButton:false,
      geocoder:false,
      homeButton:false,
      infoBox:false,
      sceneModePicker:false,
      selectionIndicator:false,
      timeline:false,
      navigationHelpButton:false,
      navigationInstructionsInitiallyVisible:false,
      contextOptions :{
        webgl : {
              alpha : true
        }
      },
      imageryProvider : new Cesium.TileMapServiceImageryProvider({
          url : './tiles',
          maximumLevel: 8
      }),
      baseLayerPicker : false
    });
    
    var start = {}; //norway starting position
    start.position = new Cesium.Cartesian3(4386332.163006191,1188368.0173394924,6153437.48635143);
    start.direction = new Cesium.Cartesian3(-0.9008236819028285,-0.3410092694636061,-0.2687552274150766);
    start.up = new Cesium.Cartesian3(-0.2423848364942298,-0.1185885488280502,0.9629051599843687);
    
    viewer.scene.skyBox.destroy();
    viewer.scene.skyBox = undefined;
    viewer.scene.sun.destroy();
    viewer.scene.sun = undefined;
    viewer.scene.moon.destroy();
    viewer.scene.moon = undefined;
    viewer.scene.skyAtmosphere.destroy();
    viewer.scene.skyAtmosphere = undefined;
    viewer.scene.backgroundColor = new Cesium.Color(0,0.0,0,0.0);
    
    /*var terrainProvider = new Cesium.CesiumTerrainProvider({
      url : '//cesiumjs.org/tilesets/terrain/smallterrain'
    });
     viewer.scene.terrainProvider = terrainProvider;*/

    var ds = new Cesium.GeoJsonDataSource();
    ds.defaultPolygon.polyline.width = new Cesium.ConstantProperty(1);
    ds.defaultPolygon.polygon = undefined;
    ds.loadUrl('./norway.json');
    
    window.onload = function() {
      var gui = new dat.GUI();
      var f0 = gui.addFolder('Camera');
      var f1 = f0.addFolder('Positon');
      gui.remember(viewer.scene.camera.position);
      f1.add(viewer.scene.camera.position, 'x').listen();
      f1.add(viewer.scene.camera.position, 'y').listen();
      f1.add(viewer.scene.camera.position, 'z').listen();
      var f1 = f0.addFolder('Direction');
      gui.remember(viewer.scene.camera.direction);
      f1.add(viewer.scene.camera.direction, 'x').listen();
      f1.add(viewer.scene.camera.direction, 'y').listen();
      f1.add(viewer.scene.camera.direction, 'z').listen();
      var f1 = f0.addFolder('Up');
      gui.remember(viewer.scene.camera.up);
      f1.add(viewer.scene.camera.up, 'x').listen();
      f1.add(viewer.scene.camera.up, 'y').listen();
      f1.add(viewer.scene.camera.up, 'z').listen();
      gui.add(SETTINGS,'Outline Norway').onChange(function(value) {
        if(value) viewer.dataSources.add(ds);
        else viewer.dataSources.remove(ds);
      });
      gui.add(SETTINGS,'Zoom');
      gui.add(SETTINGS,'Zoom Duration',0.1,30.0);
    };
  
  viewer.scene.animations.add(Cesium.CameraFlightPath.createAnimation(viewer.scene, {
    destination : start.position,
    direction: start.direction,
    up: start.up
  }));
  
   /* var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
    
      var c = viewer.scene.camera;
      console.log("--------------");
      console.log('position',c.position);
      console.log('up',c.up);
      console.log('direction',c.direction);
      console.log('viewMatrix',c.viewMatrix);
        
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);*/
  
   
   //This is the accessor function we talked about above
   var lineFunction = d3.svg.line()
                            .x(function(d) { return d.x; })
                            .y(function(d) { return d.y; })
                           .interpolate("basis");

  //The SVG Container
  var svgContainer = d3.select("body").append("svg")
                                      .attr("class","container");
  
  
    // Ellipsoid radii - WGS84 shown here
    
    var scale = 1.04; //hide point before reaching edge
    
    var rX = 6378137.0 * scale;
    var rY = 6378137.0 * scale;
    var rZ = 6356752.3142451793 * scale;
    
    viewer.scene.postRender.addEventListener(function(scene,time) {
    
      // Vector CV
      var cvX = viewer.scene.camera.position.x / rX;
      var cvY = viewer.scene.camera.position.y / rY;
      var cvZ = viewer.scene.camera.position.z / rZ;

      var vhMagnitudeSquared = cvX * cvX + cvY * cvY + cvZ * cvZ - 1.0;
      
      function getPointPosition($p){
                      
          var p = getCartPosition(parseFloat($p.data('latitude')),parseFloat($p.data('longitude')));
          
          // Target position, transformed to scaled space
          var tX = p.x / rX;
          var tY = p.y / rY;
          var tZ = p.z / rZ;

          // Vector VT
          var vtX = tX - cvX;
          var vtY = tY - cvY;
          var vtZ = tZ - cvZ;
          var vtMagnitudeSquared = vtX * vtX + vtY * vtY + vtZ * vtZ;

          // VT dot VC is the inverse of VT dot CV
          var vtDotVc = -(vtX * cvX + vtY * cvY + vtZ * cvZ);

          var isOccluded = vtDotVc > vhMagnitudeSquared &&
                           vtDotVc * vtDotVc / vtMagnitudeSquared > vhMagnitudeSquared;
          var p = Cesium.SceneTransforms.wgs84ToWindowCoordinates(scene, p);
          if(p.x && p.y)
            return {
              x: p.x,
              y: p.y,
              visible: !isOccluded
            }
          else return;
      }
      
      function getCartPosition(latitude,longitude){
          latitude = latitude * (Math.PI / 180); //radians
          longitude = longitude * (Math.PI / 180);
          return viewer.scene.globe.ellipsoid.cartographicToCartesian(new Cesium.Cartographic(longitude,latitude));
      }
      
      var lineData = [];

      $('.point').each(function(){
          var $p = $(this);
          p = getPointPosition($p);
          $p.css({
              left: p.x+'px',
              bottom: p.y+'px'
          });
          if(p.visible) $p.fadeIn();
          else $p.fadeOut();
      
      });
      
      var prevCity, prevP;
      $.each(route,function(i,city){
            var p = getPointPosition($('.'+city));
            if(p){
              if(prevP){
                if(p.visible && prevP.visible){
                  if(!lines[prevCity]) lines[prevCity] = {};
                  if(!lines[prevCity][city]) lines[prevCity][city] = svgContainer.append("path")
                                .attr("stroke", "yellow")
                                .attr("stroke-width", 3)
                               //.style("stroke-dasharray", ("10, 8"))
                                .attr("fill", "none");
                  var lineData = [];
                  lineData.push({
                    "x": prevP.x,
                    "y": $('.container').height()-prevP.y
                  });
                  lineData.push({
                    "x": p.x,
                    "y": $('.container').height()-p.y
                  });
                  lines[prevCity][city].attr("d", lineFunction(lineData));
                }else if(lines[prevCity] && lines[prevCity][city]){
                  lines[prevCity][city].remove();
                  delete lines[prevCity][city];
                }
            }
            prevCity = city;
            prevP = p;
          }
      });
      

    });
  
  </script>

</body>
</html>