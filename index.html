<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Globe</title>
    <script src="js/lib/jquery.min.js"></script>
    <script src="js/lib/jquery.transit.min.js"></script>
    <script src="js/lib/stretch-video.js"></script>
    <script src="js/lib/Cesium/Cesium.js"></script>
    <script src="js/lib/dat.gui.min.js"></script>
    <style>
      @import url(js/lib/Cesium/Widgets/widgets.css);
      #cesiumContainer {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 100%;
        margin: 0;
        overflow: hidden;
        padding: 0;
        font-family: sans-serif;
      }
      body {
        padding: 0;
        margin: 0;
        overflow: hidden;
        background-image:url(img/bg.jpg);
        background-size:cover;
      }
      #map{
        position:absolute;
        top:0;
        left:0;
        bottom:0;
        right:0;
        -webkit-filter: contrast(80%) saturate(100%) brightness(100%) sepia(25%) drop-shadow(0px 0px 40px rgb(245,245,210));
      }
      #content{
        position:absolute;
        top:0;
        left:0;
        right:0;
        bottom:0;
        background-image:url(img/content.jpg);
        background-size:cover;
        opacity:0;
      }
      #clouds{
        pointer-events:none;
      }
      .cloud.container{
        position:absolute;
        top:0%;
        left:0%;
        height:100%;
        width:100%;
        pointer-events:none;
      }
      video
      {
        position:absolute;
        pointer-events:none;
      }
      video.StretchtoFit
      {
        /* Important: No Height attribute is being specified */
        width: 100%;
      }
    </style>
  </head>
<body>
  <div id="map"></div>
  <div id="content"></div>
  <div class="cloud container">
    <video id="zoom" class="StretchtoFit" src="video/zoom.webm"></video>
    <!-- <video id="zoomReverse" class="StretchtoFit" src="video/zoom-reverse.webm"></video> -->
    <video id="clouds" class="StretchtoFit" autoplay src="video/clouds.webm" loop></video>
  </div>
  <script>
  
  /* http://cesiumjs.org/Cesium/Build/Documentation/SceneTransforms.html?classFilter=&show=all#wgs84ToWindowCoordinates */
  
  var SETTINGS = {};
  SETTINGS["Outline Norway"] = false;
  SETTINGS["Zoom Duration"] = 10.0;
  SETTINGS["Video Transition"] = 30; //point at which video is solid white, in seconds
  var isZoomed = false;
  SETTINGS["Zoom"] = function(){
    if(isZoomed){
      /*var v = document.getElementById('zoomReverse');
      v.playbackRate = v.duration/SETTINGS["Zoom Duration"];
      v.currentTime = 0;
      v.onended = function(){
        document.getElementById('zoomReverse').pause();
      }
      v.addEventListener('timeupdate',function(){
        var v = document.getElementById('zoomReverse');
        if(v.currentTime >= (v.duration - SETTINGS["Video Transition"])){
          v.pause();
          $("#content").css({opacity:0});
          v.play();
        }
      });
      v.play();*/
      $("#content").transition({opacity:0});
      viewer.scene.animations.add(Cesium.CameraFlightPath.createAnimation(viewer.scene, {
        destination : start.position,
        direction: start.direction,
        up: start.up,
        duration: SETTINGS["Zoom Duration"]*1000
      }));
    }else{
      var v = document.getElementById('zoom');
      v.playbackRate = v.duration/SETTINGS["Zoom Duration"];
      v.currentTime = 0;
      v.onended = function(){
        document.getElementById('zoom').pause();
      }
      v.addEventListener('timeupdate',function(){
        var v = document.getElementById('zoom');
        if(v.currentTime >= SETTINGS["Video Transition"]){
          v.pause();
          $("#content").css({opacity:1});
          v.play();
        }
      });
      v.play();
      viewer.scene.animations.add(Cesium.CameraFlightPath.createAnimation(viewer.scene, {
        destination : new Cesium.Cartesian3(3171739,362164.0727772717,5505013.132590841),
        duration: SETTINGS["Zoom Duration"]*1000
      }));
    }
    isZoomed = !isZoomed;
  };
  
  
    var viewer = new Cesium.Viewer('map', {
      animation:false,
      baseLayerPicker:false,
      fullscreenButton:false,
      geocoder:false,
      homeButton:false,
      infoBox:false,
      sceneModePicker:false,
      selectionIndicator:false,
      timeline:false,
      navigationHelpButton:false,
      navigationInstructionsInitiallyVisible:false,
      contextOptions :{
        webgl : {
              alpha : true
        }
      },
      imageryProvider : new Cesium.TileMapServiceImageryProvider({
          url : './tiles'
      }),
      baseLayerPicker : false
    });
    
    var start = {}; //norway starting position
    start.position = new Cesium.Cartesian3(4386332.163006191,1188368.0173394924,6153437.48635143);
    start.direction = new Cesium.Cartesian3(-0.9008236819028285,-0.3410092694636061,-0.2687552274150766);
    start.up = new Cesium.Cartesian3(-0.2423848364942298,-0.1185885488280502,0.9629051599843687);
    
    viewer.scene.skyBox.destroy();
    viewer.scene.skyBox = undefined;
    viewer.scene.sun.destroy();
    viewer.scene.sun = undefined;
    viewer.scene.moon.destroy();
    viewer.scene.moon = undefined;
    viewer.scene.skyAtmosphere.destroy();
    viewer.scene.skyAtmosphere = undefined;
    viewer.scene.backgroundColor = new Cesium.Color(0,0.0,0,0.0);
    
  /* var terrainProvider = new Cesium.CesiumTerrainProvider({
        url : '//cesiumjs.org/stk-terrain/tilesets/world/tiles'
    });
    viewer.scene.terrainProvider = terrainProvider; */
    
    var ds = new Cesium.GeoJsonDataSource();
    ds.defaultPolygon.polyline.width = new Cesium.ConstantProperty(1);
    ds.defaultPolygon.polygon = undefined;
    ds.loadUrl('./norway.json');
    
    window.onload = function() {
      var gui = new dat.GUI();
      var f0 = gui.addFolder('Camera');
      var f1 = f0.addFolder('Positon');
      gui.remember(viewer.scene.camera.position);
      f1.add(viewer.scene.camera.position, 'x').listen();
      f1.add(viewer.scene.camera.position, 'y').listen();
      f1.add(viewer.scene.camera.position, 'z').listen();
      var f1 = f0.addFolder('Direction');
      gui.remember(viewer.scene.camera.direction);
      f1.add(viewer.scene.camera.direction, 'x').listen();
      f1.add(viewer.scene.camera.direction, 'y').listen();
      f1.add(viewer.scene.camera.direction, 'z').listen();
      var f1 = f0.addFolder('Up');
      gui.remember(viewer.scene.camera.up);
      f1.add(viewer.scene.camera.up, 'x').listen();
      f1.add(viewer.scene.camera.up, 'y').listen();
      f1.add(viewer.scene.camera.up, 'z').listen();
      gui.add(SETTINGS,'Outline Norway').onChange(function(value) {
        if(value) viewer.dataSources.add(ds);
        else viewer.dataSources.remove(ds);
      });
      gui.add(SETTINGS,'Zoom');
      gui.add(SETTINGS,'Zoom Duration',0.1,30.0);
    };
  
  viewer.scene.animations.add(Cesium.CameraFlightPath.createAnimation(viewer.scene, {
    destination : start.position,
    direction: start.direction,
    up: start.up
  }));
  
   /* var handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction(function(movement) {
    
      var c = viewer.scene.camera;
      console.log("--------------");
      console.log('position',c.position);
      console.log('up',c.up);
      console.log('direction',c.direction);
      console.log('viewMatrix',c.viewMatrix);
        
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);*/
  
  
    /*viewer.scene.postRender.addEventListener(function(scene,time) {

     var position = Cesium.Ellipsoid.WGS84.cartographicToCartesian(new Cesium.Cartographic(0.0, 0.0));
     console.log(Cesium.SceneTransforms.wgs84ToWindowCoordinates(scene, position));
     
    }); */
  
  </script>

</body>
</html>